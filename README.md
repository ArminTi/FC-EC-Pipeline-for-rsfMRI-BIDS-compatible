# fMRI Resting State Analysis Pipeline

This is a MATLAB-based master pipeline for processing and analyzing resting state fMRI data. It integrates several powerful toolboxes, including SPM12, CONN, TAPAS to perform comprehensive preprocessing, functional connectivity (FC) analysis, dynamic causal modeling (DCM), and group-level parametric empirical Bayes (PEB) analyses.

## Requirements

Before running the pipeline, ensure the following requirements are met:

- **MATLAB**: R2019a or newer
- **Required packages**: 
  - [SPM12](https://www.fil.ion.ucl.ac.uk/spm/software/spm12/)
  - [CONN Toolbox](https://web.conn-toolbox.org/)
  - [TAPAS](https://github.com/ComputationalPsychiatry)
  - [HEB (Hierarchical Empirical Bayes)](https://github.com/mdgreaves/hierarchical-empirical-Bayes)
  
- **NIfTI Data**: Data should be organized in a BIDS-like format.
- **Directory structure**: Organize your dataset as `fMRI_dataset/BIDS` or adjust the path in the pipeline script.
  
### Optional: Structural Connectivity (SC) Matrix
If you plan to use hierarchical PEB for group-level DCM, you can specify the SC matrix in the `str` variable. (To just see how it works; there is a simulated DMN matrix generated by the function `simulate_DMN_SC()`).

## Installation

1. Download or clone this repository to your local machine.
2. Ensure the required packages are installed and added to the MATLAB path. You can do this manually by using the `addpath` function as shown in the script, or you can automate it via the MATLAB environment.

   ```matlab
   addpath 'C:\path\to\spm12'; 
   addpath 'C:\path\to\conn';
   addpath 'C:\path\to\rDCM-main'; 
   addpath 'C:\path\to\spDCM_Greaves';

## Usage

1. Start MATLAB and open the `master_analysis_pipeline.m` script.
2. Modify the Datadir, TR, TE, and NSUBJECTS variables as per your dataset and parameters.
3. Run the script. When prompted, input the number corresponding to the analysis step you want to perform (e.g., 1 for Preprocessing and Denoising).
4. After completing each pipeline step, the results will be saved to the specified output directory. You can visualize plots and outputs as generated by each corresponding function.

## Plotting Examples

  `EC_Plots(Datadir, name);`

![Uploading DCM_rDCM.jpg…]()

![PpSdcm95](https://github.com/user-attachments/assets/41d330b0-f2fc-4583-bf54-e9bf67da3d6e)

![Uploading PpRdcm95.jpg…]()

